<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassTrack - Teacher Attendance</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --dark: #1F2937;
            --light: #F3F4F6;
            --white: #FFFFFF;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-500: #6B7280;
            --gray-700: #374151;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 0.75rem;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--dark);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-gray-500 { color: var(--gray-500); }
        .text-primary { color: var(--primary); }
        .w-full { width: 100%; }
        .h-screen { height: 100vh; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 0.95rem;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
            box-shadow: var(--shadow);
        }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary {
            background-color: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        .btn-secondary:hover { background-color: var(--gray-100); }
        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }

        /* Inputs */
        .input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        /* Layouts */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Landing Page */
        #view-landing {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .landing-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 3rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }

        /* Scanner */
        #reader {
            width: 100%;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 1rem;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--primary);
        }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--dark); }
        .stat-label { color: var(--gray-500); font-size: 0.875rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Tables */
        .table-container {
            overflow-x: auto;
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        th {
            background-color: var(--gray-100);
            padding: 1rem;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }
        td {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            font-size: 0.95rem;
        }
        tr:hover { background-color: var(--gray-100); }
        
        /* Status Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success { background-color: #D1FAE5; color: #065F46; }
        .badge-warning { background-color: #FEF3C7; color: #92400E; }
        .badge-danger { background-color: #FEE2E2; color: #991B1B; }

        /* Navigation */
        .nav-header {
            background: var(--white);
            box-shadow: var(--shadow-sm);
            padding: 1rem 0;
            margin-bottom: 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-brand {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-links { display: flex; gap: 1rem; }
        .nav-link {
            color: var(--gray-500);
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .nav-link:hover, .nav-link.active {
            color: var(--primary);
            background-color: #EEF2FF;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            transform: translateY(20px);
            transition: transform 0.2s;
        }
        .modal-overlay.open .modal { transform: translateY(0); }

        /* QR Print */
        .qr-print-card {
            border: 2px dashed var(--gray-300);
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            page-break-inside: avoid;
        }
        
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <!-- LANDING VIEW -->
    <div id="view-landing" class="view">
        <div class="landing-card">
            <div class="mb-4">
                <i class="fas fa-school fa-3x text-primary"></i>
            </div>
            <h1 class="text-xl font-bold mb-2">ClassTrack</h1>
            <p class="text-gray-500 mb-6">Teacher Attendance System</p>
            
            <div class="flex flex-col gap-4">
                <button onclick="app.navigateTo('scanner')" class="btn btn-primary w-full">
                    <i class="fas fa-qrcode"></i> Teacher Check-in
                </button>
                <button onclick="app.navigateTo('login')" class="btn btn-secondary w-full">
                    <i class="fas fa-user-shield"></i> Principal Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="view-login" class="view hidden">
        <div class="container h-screen flex items-center justify-center">
            <div class="card" style="max-width: 400px; width: 100%;">
                <h2 class="text-xl font-bold mb-4 text-center">Principal Login</h2>
                <form onsubmit="app.handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" class="input" placeholder="Enter password (admin123)">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                    <button type="button" onclick="app.navigateTo('landing')" class="btn btn-secondary w-full mt-2">Back</button>
                </form>
            </div>
        </div>
    </div>

    <!-- SCANNER VIEW -->
    <div id="view-scanner" class="view hidden">
        <div class="nav-header">
            <div class="container nav-content">
                <div class="nav-brand"><i class="fas fa-school"></i> ClassTrack</div>
                <button onclick="app.navigateTo('landing')" class="btn btn-sm btn-secondary">Exit</button>
            </div>
        </div>
        <div class="container" style="max-width: 600px;">
            <div class="card">
                <h2 class="text-lg font-bold mb-4 text-center">Scan Classroom QR</h2>
                <div id="reader"></div>
                <div id="scan-result" class="hidden mt-4">
                    <div class="p-4 bg-green-50 border border-green-200 rounded mb-4 text-center">
                        <p class="text-green-800 font-bold" id="scanned-class-name">Class 9A</p>
                        <p class="text-sm text-green-600" id="scanned-subject">Mathematics</p>
                    </div>
                    <form onsubmit="app.handleCheckIn(event)">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teacher ID</label>
                            <input type="text" id="teacher-id-input" class="input" placeholder="Enter your ID (e.g., T001)" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Confirm Check-in</button>
                    </form>
                </div>
                <div id="scan-error" class="hidden mt-4 p-4 bg-red-50 text-red-700 rounded text-center"></div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view hidden">
        <div class="nav-header">
            <div class="container nav-content">
                <div class="nav-brand"><i class="fas fa-chart-pie"></i> Dashboard</div>
                <div class="nav-links">
                    <a onclick="app.switchTab('overview')" class="nav-link active" id="tab-overview">Overview</a>
                    <a onclick="app.switchTab('attendance')" class="nav-link" id="tab-attendance">Attendance</a>
                    <a onclick="app.switchTab('admin')" class="nav-link" id="tab-admin">Admin</a>
                    <a onclick="app.logout()" class="nav-link text-danger"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Overview Tab -->
            <div id="content-overview" class="tab-content">
                <div class="dashboard-grid">
                    <div class="stat-card" style="border-color: var(--primary);">
                        <div class="stat-value" id="stat-total-teachers">0</div>
                        <div class="stat-label">Total Teachers</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--secondary);">
                        <div class="stat-value" id="stat-checked-in">0</div>
                        <div class="stat-label">Checked In Today</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--warning);">
                        <div class="stat-value" id="stat-late">0</div>
                        <div class="stat-label">Late Arrivals</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger);">
                        <div class="stat-value" id="stat-absent">0</div>
                        <div class="stat-label">Pending / Absent</div>
                    </div>
                </div>

                <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <h3 class="font-bold mb-4">Weekly Attendance Trend</h3>
                        <canvas id="chart-attendance"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">Recent Activity</h3>
                        <div id="recent-activity-list" class="flex flex-col gap-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div id="content-attendance" class="tab-content hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold">Attendance Records</h2>
                    <div class="flex gap-2">
                        <input type="date" id="filter-date" class="input" style="width: auto;" onchange="app.renderAttendanceTable()">
                        <button onclick="app.exportData()" class="btn btn-secondary"><i class="fas fa-download"></i> Export</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="attendance-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Teacher</th>
                                <th>Class</th>
                                <th>Subject</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="content-admin" class="tab-content hidden">
                <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Teachers Management -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Teachers</h3>
                            <button onclick="app.openModal('teacher')" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i> Add</button>
                        </div>
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table id="teachers-table">
                                <thead><tr><th>ID</th><th>Name</th><th>Subject</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Classrooms Management -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Classrooms</h3>
                            <button onclick="app.openModal('classroom')" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i> Add</button>
                        </div>
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table id="classrooms-table">
                                <thead><tr><th>Class</th><th>Subject</th><th>QR</th><th>Action</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <h3 class="font-bold mb-4">System Management</h3>
                    <div class="flex gap-4">
                        <button onclick="app.resetSystem()" class="btn btn-danger">Reset All Data</button>
                        <button onclick="app.printQRCodes()" class="btn btn-secondary">Print All QR Codes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Add Item</h3>
            <form id="modal-form" onsubmit="app.handleModalSubmit(event)">
                <div id="modal-fields" class="flex flex-col gap-4">
                    <!-- Fields injected by JS -->
                </div>
                <div class="flex gap-2 mt-6 justify-end">
                    <button type="button" onclick="app.closeModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Area -->
    <div id="print-area" class="hidden"></div>

    <script>
        // --- DATA STORE ---
        const Store = {
            get: (key, defaultVal) => JSON.parse(localStorage.getItem(key)) || defaultVal,
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            
            init() {
                if (!localStorage.getItem('teachers')) {
                    this.set('teachers', [
                        { id: 'T001', name: 'John Smith', subject: 'Mathematics' },
                        { id: 'T002', name: 'Sarah Johnson', subject: 'Science' },
                        { id: 'T003', name: 'Emily Davis', subject: 'English' },
                        { id: 'T004', name: 'Michael Brown', subject: 'History' },
                        { id: 'T005', name: 'Jessica Wilson', subject: 'Art' }
                    ]);
                }
                if (!localStorage.getItem('classrooms')) {
                    this.set('classrooms', [
                        { id: 'C001', name: 'Grade 9A', subject: 'Mathematics', period: '1' },
                        { id: 'C002', name: 'Grade 10B', subject: 'Science', period: '2' },
                        { id: 'C003', name: 'Grade 11C', subject: 'English', period: '3' }
                    ]);
                }
                if (!localStorage.getItem('attendance')) {
                    // Generate some dummy data for today
                    const today = new Date().toISOString().split('T')[0];
                    this.set('attendance', [
                        { 
                            id: Date.now(), 
                            teacherId: 'T001', 
                            teacherName: 'John Smith',
                            className: 'Grade 9A',
                            subject: 'Mathematics',
                            timestamp: new Date(today + 'T08:55:00').getTime(),
                            date: today,
                            status: 'On Time'
                        }
                    ]);
                }
            }
        };

        // --- APP LOGIC ---
        const App = {
            scanner: null,
            currentScannedClass: null,

            init() {
                Store.init();
                this.renderDashboard();
                
                // Check if already logged in
                if (sessionStorage.getItem('isLoggedIn')) {
                    this.navigateTo('dashboard');
                } else {
                    this.navigateTo('landing');
                }

                // Set today's date in filter
                document.getElementById('filter-date').value = new Date().toISOString().split('T')[0];
            },

            navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');
                
                if (viewId === 'scanner') this.startScanner();
                else this.stopScanner();

                if (viewId === 'dashboard') this.renderDashboard();
            },

            // --- AUTH ---
            handleLogin(e) {
                e.preventDefault();
                const password = document.getElementById('login-password').value;
                if (password === 'admin123') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    this.navigateTo('dashboard');
                } else {
                    alert('Invalid password');
                }
            },

            logout() {
                sessionStorage.removeItem('isLoggedIn');
                this.navigateTo('landing');
            },

            // --- SCANNER ---
            startScanner() {
                document.getElementById('scan-result').classList.add('hidden');
                document.getElementById('scan-error').classList.add('hidden');
                
                this.scanner = new Html5Qrcode("reader");
                this.scanner.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        this.handleScanSuccess(decodedText);
                    },
                    (errorMessage) => {
                        // ignore errors
                    }
                ).catch(err => console.error(err));
            },

            stopScanner() {
                if (this.scanner) {
                    this.scanner.stop().then(() => {
                        this.scanner.clear();
                        this.scanner = null;
                    }).catch(err => console.error("Failed to stop scanner", err));
                }
            },

            handleScanSuccess(decodedText) {
                // Format expected: JSON string { "id": "C001", "name": "Grade 9A", "subject": "Mathematics" }
                try {
                    const data = JSON.parse(decodedText);
                    // Verify if this is a valid classroom
                    const classrooms = Store.get('classrooms', []);
                    const validClass = classrooms.find(c => c.id === data.id);

                    if (validClass) {
                        this.currentScannedClass = validClass;
                        this.stopScanner(); // Stop scanning once found
                        
                        document.getElementById('scanned-class-name').textContent = validClass.name;
                        document.getElementById('scanned-subject').textContent = validClass.subject;
                        document.getElementById('scan-result').classList.remove('hidden');
                        document.getElementById('reader').classList.add('hidden');
                    } else {
                        throw new Error("Classroom not found in system");
                    }
                } catch (e) {
                    console.error(e);
                    // Show error but keep scanning
                    // alert("Invalid QR Code");
                }
            },

            handleCheckIn(e) {
                e.preventDefault();
                const teacherId = document.getElementById('teacher-id-input').value.trim();
                const teachers = Store.get('teachers', []);
                const teacher = teachers.find(t => t.id === teacherId);

                if (!teacher) {
                    alert("Invalid Teacher ID");
                    return;
                }

                // Validation: Does teacher subject match class subject?
                // Simplified logic: Just check if subject matches. 
                // In real world, a teacher might teach multiple subjects, but we'll keep it simple.
                if (teacher.subject !== this.currentScannedClass.subject) {
                    if(!confirm(`Warning: Teacher subject (${teacher.subject}) does not match Class subject (${this.currentScannedClass.subject}). Continue?`)) {
                        return;
                    }
                }

                // Record Attendance
                const now = new Date();
                const record = {
                    id: Date.now(),
                    teacherId: teacher.id,
                    teacherName: teacher.name,
                    className: this.currentScannedClass.name,
                    subject: this.currentScannedClass.subject,
                    timestamp: now.getTime(),
                    date: now.toISOString().split('T')[0],
                    status: now.getMinutes() > 15 ? 'Late' : 'On Time' // Simple late logic: > 15 mins past hour (demo)
                };

                const attendance = Store.get('attendance', []);
                attendance.push(record);
                Store.set('attendance', attendance);

                alert(`Check-in Successful for ${teacher.name}!`);
                this.navigateTo('landing');
                document.getElementById('teacher-id-input').value = '';
            },

            // --- DASHBOARD ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                
                document.getElementById(`content-${tabId}`).classList.remove('hidden');
                document.getElementById(`tab-${tabId}`).classList.add('active');

                if (tabId === 'overview') this.renderOverview();
                if (tabId === 'attendance') this.renderAttendanceTable();
                if (tabId === 'admin') this.renderAdmin();
            },

            renderDashboard() {
                this.renderOverview();
                this.renderAttendanceTable();
                this.renderAdmin();
            },

            renderOverview() {
                const teachers = Store.get('teachers', []);
                const attendance = Store.get('attendance', []);
                const today = new Date().toISOString().split('T')[0];
                
                const todayRecords = attendance.filter(r => r.date === today);
                
                // Stats
                document.getElementById('stat-total-teachers').textContent = teachers.length;
                document.getElementById('stat-checked-in').textContent = new Set(todayRecords.map(r => r.teacherId)).size;
                document.getElementById('stat-late').textContent = todayRecords.filter(r => r.status === 'Late').length;
                document.getElementById('stat-absent').textContent = teachers.length - new Set(todayRecords.map(r => r.teacherId)).size;

                // Recent Activity
                const recentList = document.getElementById('recent-activity-list');
                recentList.innerHTML = '';
                [...attendance].sort((a,b) => b.timestamp - a.timestamp).slice(0, 5).forEach(r => {
                    const time = new Date(r.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    recentList.innerHTML += `
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                            <div>
                                <div class="font-semibold">${r.teacherName}</div>
                                <div class="text-xs text-gray-500">${r.className} â€¢ ${r.subject}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-primary">${time}</div>
                                <div class="text-xs ${r.status === 'Late' ? 'text-red-500' : 'text-green-500'}">${r.status}</div>
                            </div>
                        </div>
                    `;
                });

                // Chart
                this.renderChart(attendance);
            },

            renderChart(attendance) {
                const ctx = document.getElementById('chart-attendance').getContext('2d');
                // Group by date (last 7 days)
                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();

                const data = last7Days.map(date => {
                    return attendance.filter(r => r.date === date).length;
                });

                if (window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last7Days.map(d => d.slice(5)), // MM-DD
                        datasets: [{
                            label: 'Check-ins',
                            data: data,
                            backgroundColor: '#4F46E5',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
            },

            renderAttendanceTable() {
                const filterDate = document.getElementById('filter-date').value;
                const attendance = Store.get('attendance', []);
                const filtered = attendance.filter(r => !filterDate || r.date === filterDate);
                
                const tbody = document.querySelector('#attendance-table tbody');
                tbody.innerHTML = '';
                
                filtered.sort((a,b) => b.timestamp - a.timestamp).forEach(r => {
                    const time = new Date(r.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const badgeClass = r.status === 'Late' ? 'badge-warning' : 'badge-success';
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${time}</td>
                            <td>${r.teacherName}</td>
                            <td>${r.className}</td>
                            <td>${r.subject}</td>
                            <td><span class="badge ${badgeClass}">${r.status}</span></td>
                        </tr>
                    `;
                });
            },

            renderAdmin() {
                // Teachers Table
                const teachers = Store.get('teachers', []);
                const tBody = document.querySelector('#teachers-table tbody');
                tBody.innerHTML = '';
                teachers.forEach(t => {
                    tBody.innerHTML += `
                        <tr>
                            <td>${t.id}</td>
                            <td>${t.name}</td>
                            <td>${t.subject}</td>
                            <td>
                                <button onclick="app.deleteItem('teachers', '${t.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });

                // Classrooms Table
                const classrooms = Store.get('classrooms', []);
                const cBody = document.querySelector('#classrooms-table tbody');
                cBody.innerHTML = '';
                classrooms.forEach(c => {
                    cBody.innerHTML += `
                        <tr>
                            <td>${c.name}</td>
                            <td>${c.subject}</td>
                            <td>
                                <button onclick="app.showQR('${c.id}')" class="text-primary hover:text-primary-dark mr-2"><i class="fas fa-qrcode"></i></button>
                            </td>
                            <td>
                                <button onclick="app.deleteItem('classrooms', '${c.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            },

            // --- ADMIN ACTIONS ---
            openModal(type) {
                const modal = document.getElementById('modal-overlay');
                const title = document.getElementById('modal-title');
                const fields = document.getElementById('modal-fields');
                const form = document.getElementById('modal-form');
                
                modal.classList.add('open');
                form.dataset.type = type;

                if (type === 'teacher') {
                    title.textContent = 'Add Teacher';
                    fields.innerHTML = `
                        <input type="text" name="id" class="input" placeholder="Teacher ID (e.g. T006)" required>
                        <input type="text" name="name" class="input" placeholder="Full Name" required>
                        <input type="text" name="subject" class="input" placeholder="Subject" required>
                    `;
                } else {
                    title.textContent = 'Add Classroom';
                    fields.innerHTML = `
                        <input type="text" name="id" class="input" placeholder="Class ID (e.g. C004)" required>
                        <input type="text" name="name" class="input" placeholder="Class Name (e.g. Grade 12A)" required>
                        <input type="text" name="subject" class="input" placeholder="Subject" required>
                    `;
                }
            },

            closeModal() {
                document.getElementById('modal-overlay').classList.remove('open');
            },

            handleModalSubmit(e) {
                e.preventDefault();
                const type = e.target.dataset.type;
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                if (type === 'teacher') {
                    const teachers = Store.get('teachers', []);
                    teachers.push(data);
                    Store.set('teachers', teachers);
                } else {
                    const classrooms = Store.get('classrooms', []);
                    classrooms.push(data);
                    Store.set('classrooms', classrooms);
                }

                this.closeModal();
                this.renderAdmin();
                this.renderOverview(); // Update stats
            },

            deleteItem(collection, id) {
                if(confirm('Are you sure?')) {
                    const items = Store.get(collection, []);
                    const newItems = items.filter(i => i.id !== id);
                    Store.set(collection, newItems);
                    this.renderAdmin();
                    this.renderOverview();
                }
            },

            resetSystem() {
                if(confirm('WARNING: This will delete ALL data. Are you sure?')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            // --- EXPORT & PRINT ---
            exportData() {
                const attendance = Store.get('attendance', []);
                let csv = 'Date,Time,Teacher,Class,Subject,Status\n';
                attendance.forEach(r => {
                    const time = new Date(r.timestamp).toLocaleTimeString();
                    csv += `${r.date},${time},${r.teacherName},${r.className},${r.subject},${r.status}\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'attendance_report.csv';
                a.click();
            },

            showQR(classId) {
                const classrooms = Store.get('classrooms', []);
                const cls = classrooms.find(c => c.id === classId);
                if (!cls) return;

                // Create a temporary modal to show QR
                const qrData = JSON.stringify({ id: cls.id, name: cls.name, subject: cls.subject });
                
                // We'll reuse the modal overlay but inject custom content
                const modal = document.getElementById('modal-overlay');
                const fields = document.getElementById('modal-fields');
                document.getElementById('modal-title').textContent = `QR Code: ${cls.name}`;
                document.getElementById('modal-form').onsubmit = (e) => { e.preventDefault(); this.closeModal(); }; // Just close
                
                fields.innerHTML = `<div id="qrcode-display" class="flex justify-center p-4"></div>`;
                modal.classList.add('open');

                // Wait for DOM update
                setTimeout(() => {
                    document.getElementById('qrcode-display').innerHTML = '';
                    new QRCode(document.getElementById("qrcode-display"), {
                        text: qrData,
                        width: 200,
                        height: 200
                    });
                }, 100);
            },

            printQRCodes() {
                const classrooms = Store.get('classrooms', []);
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = '';

                classrooms.forEach(cls => {
                    const div = document.createElement('div');
                    div.className = 'qr-print-card';
                    div.innerHTML = `
                        <h3>${cls.name}</h3>
                        <p>${cls.subject}</p>
                        <div id="qr-${cls.id}" style="display:inline-block; margin: 10px;"></div>
                    `;
                    printArea.appendChild(div);
                    
                    new QRCode(document.getElementById(`qr-${cls.id}`), {
                        text: JSON.stringify({ id: cls.id, name: cls.name, subject: cls.subject }),
                        width: 150,
                        height: 150
                    });
                });

                setTimeout(() => window.print(), 500);
            }
        };

        // Initialize App
        window.app = App;
        App.init();
    </script>
</body>
</html>
