<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZCM Track - Administrator</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <script src="schedule.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>

<body>

    <!-- LOGIN VIEW -->
    <div id="view-login" class="view">
        <div class="container h-screen flex items-center justify-center">
            <div class="card login-card">
                <h2 class="text-xl font-bold mb-4 text-center">ZCM Track - Administrator</h2>
                <div class="flex flex-col items-center gap-4">
                    <div id="g_id_onload"
                        data-client_id="840411102964-5vqmoroj9jdcthf099ikvadofcgveefv.apps.googleusercontent.com"
                        data-callback="handleGoogleLogin" data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"
                        data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view hidden">
        <div class="nav-header">
            <div class="container nav-content">
                <div class="nav-brand"><i class="fas fa-chart-pie"></i> Dashboard</div>
                <div class="nav-links">
                    <a onclick="app.switchTab('overview')" class="nav-link active" id="tab-overview">Overview</a>
                    <a onclick="app.switchTab('matrix')" class="nav-link" id="tab-matrix">Matrix</a>
                    <a onclick="app.switchTab('teacher-stats')" class="nav-link" id="tab-teacher-stats">Teacher
                        Stats</a>
                    <a onclick="app.switchTab('admin')" class="nav-link" id="tab-admin">Admin</a>
                    <a onclick="app.logout()" class="nav-link text-danger"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Overview Tab -->
            <div id="content-overview" class="tab-content">
                <div class="dashboard-grid">
                    <div class="stat-card" style="border-color: #059669;">
                        <div class="stat-value" id="stat-on-time">0</div>
                        <div class="stat-label">Checked in on time</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--warning);">
                        <div class="stat-value" id="stat-late">0</div>
                        <div class="stat-label">Late Arrivals</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--danger);">
                        <div class="stat-value" id="stat-absent">0</div>
                        <div class="stat-label">Absent / No Teacher</div>
                    </div>
                </div>

                <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="card">
                        <h3 class="font-bold mb-4">Weekly Attendance Trend</h3>
                        <canvas id="chart-attendance"></canvas>
                    </div>
                    <div class="card">
                        <h3 class="font-bold mb-4">Recent Activity</h3>
                        <div id="recent-activity-list" class="flex flex-col gap-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Matrix Tab -->
            <div id="content-matrix" class="tab-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-lg font-bold">Class Period Matrix</h2>
                    <div class="flex gap-2 flex-wrap">
                        <select id="matrix-grade" class="input" style="width: auto;" onchange="app.renderMatrix()">
                            <option value="">All Grades</option>
                            <option value="6">Grade 6</option>
                            <option value="7">Grade 7</option>
                            <option value="8">Grade 8</option>
                            <option value="9">Grade 9</option>
                            <option value="10">Grade 10</option>
                            <option value="11">Grade 11</option>
                        </select>
                        <input type="date" id="matrix-date" class="input" style="width: auto;"
                            onchange="app.renderMatrix()">
                    </div>
                </div>
                <div class="table-container">
                    <table id="matrix-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>P1</th>
                                <th>P2</th>
                                <th>P3</th>
                                <th>P4</th>
                                <th>P5</th>
                                <th>P6</th>
                                <th>P7</th>
                                <th>P8</th>
                                <th>P9</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Teacher Stats Tab -->
            <div id="content-teacher-stats" class="tab-content hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h1 class="text-xl font-bold mb-2">ZCM Track</h1>
                    <p class="text-gray-500 mb-6">Teacher Attendance System</p>
                    <select id="stats-teacher-select" class="input" style="max-width: 300px;"
                        onchange="app.renderTeacherStats()">
                        <option value="" disabled selected>Select a Teacher</option>
                        <!-- Populated by JS -->
                    </select>
                </div>

                <div class="dashboard-grid" style="grid-template-columns: 2fr 1fr;">
                    <!-- Left Panel: Daily Detail -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700">Daily Detail</h3>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-500">Date</label>
                                <input type="date" id="stats-date" class="input" style="width: auto; padding: 0.5rem;"
                                    onchange="app.renderTeacherStats()">
                            </div>
                        </div>
                        <div class="table-container" style="box-shadow: none; border: 1px solid var(--gray-200);">
                            <table id="stats-daily-table">
                                <thead>
                                    <tr>
                                        <th>Period</th>
                                        <th>Time</th>
                                        <th>Late by</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Right Panel: Summary -->
                    <div class="card bg-gray-50">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-700">Summary</h3>
                            <select id="stats-period-filter" class="input"
                                style="width: auto; padding: 0.25rem 0.5rem; font-size: 0.8rem;"
                                onchange="app.renderTeacherStats()">
                                <option value="weekly">Weekly</option>
                                <option value="monthly" selected>Monthly</option>
                            </select>
                        </div>

                        <div class="flex flex-col gap-6">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl font-bold text-dark" id="summary-on-time">0</div>
                                <div class="text-sm text-gray-500">On time</div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-4xl font-bold text-dark" id="summary-late-10">0</div>
                                <div class="text-sm text-gray-500">10 Minutes delay</div>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-4xl font-bold text-dark" id="summary-late-20">0</div>
                                <div class="text-sm text-gray-500">20 Minutes delay</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="content-admin" class="tab-content hidden">
                <div class="grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- Teachers Management -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Teachers</h3>
                            <button onclick="app.openModal('teacher')" class="btn btn-sm btn-primary"><i
                                    class="fas fa-plus"></i> Add</button>
                        </div>
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table id="teachers-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Subject</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Classrooms Management -->
                    <div class="card">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold">Classrooms</h3>
                        </div>
                        <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                            <table id="classrooms-table">
                                <thead>
                                    <tr>
                                        <th>Class</th>
                                        <th>QR</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <h3 class="font-bold mb-4">System Management</h3>
                    <div class="flex gap-4">
                        <button onclick="app.resetSystem()" class="btn btn-danger">Reset All Data</button>
                        <button onclick="app.printQRCodes()" class="btn btn-secondary">Print All QR Codes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h3 id="modal-title" class="text-lg font-bold mb-4">Add Item</h3>
            <form id="modal-form" onsubmit="app.handleModalSubmit(event)">
                <div id="modal-fields" class="flex flex-col gap-4">
                    <!-- Fields injected by JS -->
                </div>
                <div class="flex gap-2 mt-6 justify-end">
                    <button type="button" onclick="app.closeModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Area -->
    <div id="print-area" class="hidden"></div>

    <script>
        // Global callback for Google Auth
        function handleGoogleLogin(response) {
            app.handleGoogleLogin(response);
        }

        // --- DATA STORE ---
        const Store = {
            get: (key, defaultVal) => JSON.parse(localStorage.getItem(key)) || defaultVal,
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),

            init() {
                if (!localStorage.getItem('teachers')) {
                    this.set('teachers', [
                        { id: 'T001', name: 'John Smith', subject: 'Mathematics' },
                        { id: 'T002', name: 'Sarah Johnson', subject: 'Science' },
                        { id: 'T003', name: 'Emily Davis', subject: 'English' },
                        { id: 'T004', name: 'Michael Brown', subject: 'History' },
                        { id: 'T005', name: 'Jessica Wilson', subject: 'Art' }
                    ]);
                }
                if (!localStorage.getItem('classrooms')) {
                    const grades = [6, 7, 8, 9, 10, 11];
                    const sections = ['A', 'B', 'C', 'D', 'E1', 'E2'];
                    const classrooms = [];
                    let idCounter = 1;

                    grades.forEach(grade => {
                        sections.forEach(section => {
                            classrooms.push({
                                id: `C${String(idCounter++).padStart(3, '0')}`,
                                name: `Grade ${grade}${section}`,
                                subject: 'General'
                            });
                        });
                    });
                    this.set('classrooms', classrooms);
                }
                if (!localStorage.getItem('attendance')) {
                    const today = new Date().toISOString().split('T')[0];
                    this.set('attendance', [
                        {
                            id: Date.now(),
                            teacherId: 'T001',
                            teacherName: 'John Smith',
                            className: 'Grade 9A',
                            subject: 'Mathematics',
                            timestamp: new Date(today + 'T08:55:00').getTime(),
                            date: today,
                            status: 'On Time'
                        }
                    ]);
                }
            }
        };

        // --- APP LOGIC ---
        const app = {
            chart: null,

            init() {
                Store.init();

                // Check if already logged in
                if (sessionStorage.getItem('isLoggedIn')) {
                    this.navigateTo('dashboard');
                } else {
                    this.navigateTo('login');
                }
            },

            navigateTo(viewId) {
                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');

                if (viewId === 'dashboard') this.renderDashboard();
            },

            // --- AUTH ---
            handleGoogleLogin(response) {
                console.log("Google Auth Response:", response);
                if (response.credential) {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    console.log("Logged in as:", payload.email);

                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('userEmail', payload.email);
                    this.navigateTo('dashboard');
                }
            },

            logout() {
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('userEmail');
                this.navigateTo('login');
            },

            // --- DASHBOARD ---
            switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

                document.getElementById(`content-${tabId}`).classList.remove('hidden');
                document.getElementById(`tab-${tabId}`).classList.add('active');

                if (tabId === 'overview') this.renderOverview();
                if (tabId === 'matrix') this.renderMatrix();
                if (tabId === 'teacher-stats') this.renderTeacherStats();
                if (tabId === 'admin') this.renderAdmin();
            },

            renderTeacherStats() {
                const teacherSelect = document.getElementById('stats-teacher-select');
                if (teacherSelect.options.length === 1) {
                    const teachers = Store.get('teachers', []);
                    teachers.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.id;
                        opt.textContent = t.name;
                        teacherSelect.appendChild(opt);
                    });
                }

                const selectedTeacherId = teacherSelect.value;
                const dateInput = document.getElementById('stats-date');
                if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
                const selectedDate = dateInput.value;
                const summaryFilter = document.getElementById('stats-period-filter').value;

                if (!selectedTeacherId) return;

                const attendance = Store.get('attendance', []);
                const tbody = document.querySelector('#stats-daily-table tbody');
                tbody.innerHTML = '';

                const periods = Schedule.periods.filter(p => p.type !== 'break');

                periods.forEach(p => {
                    const record = attendance.find(r =>
                        r.teacherId === selectedTeacherId &&
                        r.date === selectedDate &&
                        String(r.period) === String(p.id)
                    );

                    let timeDisplay = '-';
                    let lateDisplay = '-';

                    if (record) {
                        const recordDate = new Date(record.timestamp);
                        timeDisplay = recordDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        const statusInfo = Schedule.calculateStatus(p, recordDate);
                        const diffMins = statusInfo.delayMins;

                        if (diffMins <= 5) {
                            lateDisplay = '<span class="font-bold text-green-600">On time</span>';
                        } else if (diffMins <= 15) {
                            lateDisplay = `<span class="font-bold text-yellow-600">${diffMins} minutes</span>`;
                        } else {
                            lateDisplay = `<span class="font-bold text-red-600">${diffMins} minutes</span>`;
                        }
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td class="font-medium">${p.name}</td>
                            <td class="font-bold">${timeDisplay}</td>
                            <td>${lateDisplay}</td>
                        </tr>
                    `;
                });

                const now = new Date();
                let startDate = new Date();
                if (summaryFilter === 'weekly') {
                    startDate.setDate(now.getDate() - 7);
                } else {
                    startDate.setDate(1);
                }

                const summaryRecords = attendance.filter(r =>
                    r.teacherId === selectedTeacherId &&
                    new Date(r.date) >= startDate
                );

                let onTimeCount = 0;
                let late10Count = 0;
                let late20Count = 0;

                summaryRecords.forEach(r => {
                    const period = Schedule.periods.find(p => String(p.id) === String(r.period));
                    if (period && period.type !== 'break') {
                        const rDate = new Date(r.timestamp);
                        const statusInfo = Schedule.calculateStatus(period, rDate);
                        const diffMins = statusInfo.delayMins;

                        if (diffMins <= 5) onTimeCount++;
                        else if (diffMins <= 15) late10Count++;
                        else late20Count++;
                    }
                });

                document.getElementById('summary-on-time').textContent = onTimeCount;
                document.getElementById('summary-late-10').textContent = late10Count;
                document.getElementById('summary-late-20').textContent = late20Count;
            },

            renderMatrix() {
                const filterGrade = document.getElementById('matrix-grade').value;
                const filterDate = document.getElementById('matrix-date').value || new Date().toISOString().split('T')[0];
                document.getElementById('matrix-date').value = filterDate;

                const classrooms = Store.get('classrooms', []);
                const attendance = Store.get('attendance', []);

                const filteredClasses = classrooms.filter(c => !filterGrade || c.name.includes(`Grade ${filterGrade}`));
                filteredClasses.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));

                const tbody = document.querySelector('#matrix-table tbody');
                const thead = document.querySelector('#matrix-table thead tr');

                const periods = Schedule.periods.filter(p => p.type !== 'break');
                let headerHtml = '<th>Class</th>';
                periods.forEach(p => {
                    headerHtml += `<th>P${p.id}</th>`;
                });
                thead.innerHTML = headerHtml;

                tbody.innerHTML = '';

                filteredClasses.forEach(cls => {
                    let rowHtml = `<tr><td class="font-bold">${cls.name}</td>`;

                    periods.forEach(p => {
                        const record = attendance.find(r =>
                            r.className === cls.name &&
                            r.date === filterDate &&
                            String(r.period) === String(p.id)
                        );

                        if (record) {
                            const time = new Date(record.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const statusColor = record.status === 'Late' ? 'text-red-600' : 'text-green-600';
                            rowHtml += `
                                <td class="text-xs">
                                    <div class="font-bold">${record.teacherName}</div>
                                    <div class="${statusColor}">${time}</div>
                                </td>
                            `;
                        } else {
                            rowHtml += `<td></td>`;
                        }
                    });

                    rowHtml += `</tr>`;
                    tbody.innerHTML += rowHtml;
                });
            },

            renderDashboard() {
                this.renderOverview();
                this.renderAdmin();
            },

            renderOverview() {
                const teachers = Store.get('teachers', []);
                const attendance = Store.get('attendance', []);
                const today = new Date().toISOString().split('T')[0];

                const todayRecords = attendance.filter(r => r.date === today);

                document.getElementById('stat-on-time').textContent = todayRecords.filter(r => r.status === 'On Time').length;
                document.getElementById('stat-late').textContent = todayRecords.filter(r => r.status === 'Late').length;
                document.getElementById('stat-absent').textContent = teachers.length - new Set(todayRecords.map(r => r.teacherId)).size;

                // Chart
                const ctx = document.getElementById('chart-attendance').getContext('2d');
                if (this.chart) this.chart.destroy();

                const last7Days = [...Array(7)].map((_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();

                const data = last7Days.map(date => attendance.filter(r => r.date === date).length);

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Check-ins',
                            data: data,
                            borderColor: '#800000',
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true }
                });

                // Recent Activity
                const list = document.getElementById('recent-activity-list');
                list.innerHTML = '';
                const recent = [...attendance].sort((a, b) => b.timestamp - a.timestamp).slice(0, 5);

                recent.forEach(r => {
                    const time = new Date(r.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    list.innerHTML += `
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <div>
                                <div class="font-bold text-sm">${r.teacherName}</div>
                                <div class="text-xs text-gray-500">${r.className} â€¢ ${r.subject}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm">${time}</div>
                                <div class="text-xs ${r.status === 'Late' ? 'text-red-600' : 'text-green-600'}">${r.status}</div>
                            </div>
                        </div>
                    `;
                });
            },

            renderAdmin() {
                // Teachers Table
                const teachers = Store.get('teachers', []);
                const tBody = document.querySelector('#teachers-table tbody');
                tBody.innerHTML = '';
                teachers.forEach(t => {
                    tBody.innerHTML += `
                        <tr>
                            <td>${t.id}</td>
                            <td>${t.name}</td>
                            <td>${t.subject}</td>
                        </tr>
                    `;
                });

                // Classrooms Table
                const classrooms = Store.get('classrooms', []);
                const cBody = document.querySelector('#classrooms-table tbody');
                cBody.innerHTML = '';
                classrooms.forEach(c => {
                    cBody.innerHTML += `
                        <tr>
                            <td>${c.name}</td>
                            <td><button onclick="app.showQR('${c.id}')" class="text-blue-600"><i class="fas fa-qrcode"></i></button></td>
                        </tr>
                    `;
                });
            },

            // --- ADMIN ACTIONS ---
            openModal(type) {
                document.getElementById('modal-overlay').classList.add('active');
                const form = document.getElementById('modal-fields');
                form.dataset.type = type;
                document.getElementById('modal-title').textContent = type === 'teacher' ? 'Add Teacher' : 'Add Classroom';

                if (type === 'teacher') {
                    form.innerHTML = `
                        <input type="text" name="id" class="input" placeholder="Teacher ID (e.g. T001)" required>
                        <input type="text" name="name" class="input" placeholder="Full Name" required>
                        <input type="text" name="subject" class="input" placeholder="Subject" required>
                    `;
                } else {
                    form.innerHTML = `
                        <input type="text" name="id" class="input" placeholder="Class ID (e.g. C001)" required>
                        <input type="text" name="name" class="input" placeholder="Class Name (e.g. Grade 10A)" required>
                        <input type="text" name="subject" class="input" placeholder="Subject (e.g. Mathematics)" required>
                    `;
                }
            },

            closeModal() {
                document.getElementById('modal-overlay').classList.remove('active');
            },

            handleModalSubmit(e) {
                e.preventDefault();
                const form = document.getElementById('modal-fields');
                const type = form.dataset.type;
                const inputs = form.querySelectorAll('input');
                const data = {};
                inputs.forEach(i => data[i.name] = i.value);

                const key = type === 'teacher' ? 'teachers' : 'classrooms';
                const items = Store.get(key, []);
                items.push(data);
                Store.set(key, items);

                this.closeModal();
                this.renderAdmin();
            },

            deleteItem(key, id) {
                if (confirm('Are you sure?')) {
                    const items = Store.get(key, []);
                    const newItems = items.filter(i => i.id !== id);
                    Store.set(key, newItems);
                    this.renderAdmin();
                }
            },

            resetSystem() {
                if (confirm('DANGER: This will wipe all data. Continue?')) {
                    localStorage.clear();
                    location.reload();
                }
            },

            showQR(classId) {
                const classrooms = Store.get('classrooms', []);
                const cls = classrooms.find(c => c.id === classId);
                if (!cls) return;

                // Create a temporary modal for QR
                const div = document.createElement('div');
                div.className = 'modal-overlay active';
                div.innerHTML = `
                    <div class="modal text-center">
                        <h3 class="font-bold mb-4">${cls.name} - ${cls.subject}</h3>
                        <div id="qrcode-display" class="flex justify-center mb-4"></div>
                        <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-secondary">Close</button>
                    </div>
                `;
                document.body.appendChild(div);

                new QRCode(div.querySelector('#qrcode-display'), {
                    text: JSON.stringify({ id: cls.id, name: cls.name }), // Removed subject from QR
                    width: 200,
                    height: 200
                });
            },

            printQRCodes() {
                const classrooms = Store.get('classrooms', []);
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = '';
                printArea.classList.remove('hidden');

                classrooms.forEach(cls => {
                    const container = document.createElement('div');
                    container.className = 'qr-print-item';
                    container.innerHTML = `
                        <h3>${cls.name}</h3>
                        <div class="qr-code"></div>
                    `;
                    printArea.appendChild(container);

                    new QRCode(container.querySelector('.qr-code'), {
                        text: JSON.stringify({ id: cls.id, name: cls.name }), // Removed subject from QR
                        width: 150,
                        height: 150
                    });
                });

                setTimeout(() => {
                    window.print();
                    printArea.classList.add('hidden');
                }, 500);
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>

</html>