<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassTrack - Teacher Check-in</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="schedule.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>

<body>

    <!-- SCANNER VIEW -->
    <div id="view-scanner" class="view">
        <div class="nav-header">
            <div class="container nav-content">
                <div class="nav-brand"><i class="fas fa-school"></i> ClassTrack</div>
            </div>
        </div>
        <div class="container scanner-container">
            <div class="card">
                <h2 class="text-lg font-bold mb-4 text-center">Scan Classroom QR</h2>
                <div id="reader"></div>
                <div id="scan-result" class="hidden mt-4">
                    <div class="p-4 bg-green-50 border border-green-200 rounded mb-4 text-center">
                        <p class="text-green-800 font-bold" id="scanned-class-name">Class 9A</p>
                        <p class="text-sm text-green-600" id="scanned-subject">Mathematics</p>
                    </div>
                    <form onsubmit="app.handleCheckIn(event)">
                        <div class="mb-4">
                            <div class="p-3 bg-blue-50 text-blue-800 rounded text-center">
                                <span id="auto-period-display" class="font-bold">Detecting Period...</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teacher ID</label>
                            <input type="text" id="teacher-id-input" class="input"
                                placeholder="Enter your ID (e.g., T001)" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Confirm Check-in</button>
                    </form>
                </div>
                <div id="scan-error" class="hidden mt-4 p-4 bg-red-50 text-red-700 rounded text-center"></div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const Store = {
            get: (key, defaultVal) => JSON.parse(localStorage.getItem(key)) || defaultVal,
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            init() {
                // Ensure data exists (shared with admin)
                if (!localStorage.getItem('teachers')) localStorage.setItem('teachers', '[]');
                if (!localStorage.getItem('classrooms')) localStorage.setItem('classrooms', '[]');
                if (!localStorage.getItem('attendance')) localStorage.setItem('attendance', '[]');
            }
        };

        // --- APP LOGIC ---
        const app = {
            scanner: null,
            currentScannedClass: null,

            init() {
                Store.init();
                this.startScanner();
            },

            // --- SCANNER ---
            startScanner() {
                document.getElementById('scan-result').classList.add('hidden');
                document.getElementById('scan-error').classList.add('hidden');

                this.scanner = new Html5Qrcode("reader");
                this.scanner.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (decodedText) => {
                        this.handleScanSuccess(decodedText);
                    },
                    (errorMessage) => {
                        // ignore errors
                    }
                ).catch(err => console.error(err));
            },

            stopScanner() {
                if (this.scanner) {
                    this.scanner.stop().then(() => {
                        this.scanner.clear();
                        this.scanner = null;
                    }).catch(err => console.error("Failed to stop scanner", err));
                }
            },

            handleScanSuccess(decodedText) {
                try {
                    const data = JSON.parse(decodedText);
                    const classrooms = Store.get('classrooms', []);
                    const validClass = classrooms.find(c => c.id === data.id);

                    if (validClass) {
                        this.currentScannedClass = validClass;
                        this.stopScanner();

                        document.getElementById('scanned-class-name').textContent = validClass.name;
                        document.getElementById('scanned-subject').textContent = validClass.subject;

                        // Auto-detect period
                        const currentPeriod = Schedule.getCurrentPeriod();
                        const periodDisplay = document.getElementById('auto-period-display');

                        if (currentPeriod) {
                            periodDisplay.textContent = `Current: ${currentPeriod.name} (${currentPeriod.start} - ${currentPeriod.end})`;
                            periodDisplay.className = "font-bold text-blue-800";
                            if (currentPeriod.type === 'break') {
                                periodDisplay.textContent = `Current: ${currentPeriod.name} (No Class)`;
                                periodDisplay.className = "font-bold text-orange-800";
                            }
                        } else {
                            periodDisplay.textContent = "No Active Period";
                            periodDisplay.className = "font-bold text-red-800";
                        }

                        document.getElementById('scan-result').classList.remove('hidden');
                        document.getElementById('reader').classList.add('hidden');
                    } else {
                        throw new Error("Classroom not found in system");
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            handleCheckIn(e) {
                e.preventDefault();
                const teacherId = document.getElementById('teacher-id-input').value.trim();

                const currentPeriod = Schedule.getCurrentPeriod();

                if (!currentPeriod) {
                    alert("No active period found. Cannot check in.");
                    return;
                }

                if (currentPeriod.type === 'break') {
                    if (!confirm(`It is currently ${currentPeriod.name}. Do you want to check in anyway? (Will be recorded as ${currentPeriod.name})`)) {
                        return;
                    }
                }

                const teachers = Store.get('teachers', []);
                const teacher = teachers.find(t => t.id === teacherId);

                if (!teacher) {
                    alert("Invalid Teacher ID");
                    return;
                }

                if (teacher.subject !== this.currentScannedClass.subject) {
                    if (!confirm(`Warning: Teacher subject (${teacher.subject}) does not match Class subject (${this.currentScannedClass.subject}). Continue?`)) {
                        return;
                    }
                }

                const now = new Date();
                const statusInfo = Schedule.calculateStatus(currentPeriod, now);

                const record = {
                    id: Date.now(),
                    teacherId: teacher.id,
                    teacherName: teacher.name,
                    className: this.currentScannedClass.name,
                    subject: this.currentScannedClass.subject,
                    period: currentPeriod.id,
                    timestamp: now.getTime(),
                    date: now.toISOString().split('T')[0],
                    status: statusInfo.status
                };

                const attendance = Store.get('attendance', []);
                attendance.push(record);
                Store.set('attendance', attendance);

                alert(`Check-in Successful for ${teacher.name} (${currentPeriod.name})!`);
                location.reload(); // Reload to restart scanner
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>

</html>